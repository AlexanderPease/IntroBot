tinymce.PluginManager.add("charcount", function (e) {
    var max_chars = parseInt(e.getParam("charcount_max_chars", 1000), 10);
    function t() {
        var count = a.getCount();
        var panel = e.theme.panel.find("#charcount");
        panel.text(["Characters: {0} / {1}", count, max_chars]);
        if(count > max_chars) {
            if(!panel.hasClass('charcount-overflow')) {
                e.theme.panel.find("#charcount").addClass('charcount-overflow');
            }
        } else {
            if(panel.hasClass('charcount-overflow')) {
                e.theme.panel.find("#charcount").removeClass('charcount-overflow');
            }
        }
    }
    var n, i, a = this;
    e.on("init", function () {
        var n = e.theme.panel && e.theme.panel.find("#statusbar")[0];
        n && window.setTimeout(function () {
            n.insert({
                type: "label",
                name: "charcount",
                text: ["Characters: {0} / {1}", a.getCount(), max_chars],
                classes: "charcount"
                }, 0);
            e.on("setcontent beforeaddundo", t);
            e.on("keyup", t);
        }, 0);
    });
    a.getCount = function () {
        var t = e.getBody();
        t = t.innerText || t.textContent;
        return t.length;
    }
});